<!DOCTYPE html>
<html>

<head>
    <title>{{ pageName|default("Data Table") }}</title>
    <meta charset="utf-8">
    <meta http-equiv="refresh" content={{ refresh_interval|default(1800) }}>
    <link rel="stylesheet" href="{{ url_for('static', path='/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='/bootstrap5/bootstrap.min.css') }}">

    <link rel="stylesheet" href="{{ url_for('static', path='/jquery.dataTables.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='/buttons.dataTables.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='/scroller.dataTables.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='/select.dataTables.min.css') }}">

    <script type="text/javascript" src="{{ url_for('static', path='/jquery-3.5.1.min.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', path='/jquery.dataTables.min.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', path='/dataTables.buttons.min.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', path='/buttons.html5.min.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', path='/dataTables.scroller.min.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', path='/dataTables.select.min.js') }}"></script>

    <script type="text/javascript" src="{{ url_for('static', path='/bootstrap5/bootstrap.min.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', path='/chart.umd.min.js') }}"></script>
    <script type="text/javascript" src="{{ url_for('static', path='/chartjs-plugin-zoom.min.js') }}"></script>


</head>

<body>

    <div class="container-fluid">
        <p class="text-end display-6">Retrieved at <strong>{{ retrieved_datetime }}</strong></p>
        <button id="resetZoomBtn" class="btn btn-outline-dark btn-sm">Reset Zoom</button>
    </div>
    <div class="container-fluid">
        <canvas id="myChart"></canvas>
    </div>
    <div class="container-fluid">
        <table id="data-table" class="display compact mono" style="width:100%">
            <thead>
                <tr>
                    {% for column in columns %}
                    <th>{{ column }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for row in rows %}
                <tr>
                    {% for column in columns %}
                    <td>{{ row[column] }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr>
                    {% for column in columns %}
                    <th>{{ column }}</th>
                    {% endfor %}
                </tr>
            </tfoot>
        </table>
    </div>


    <script type="text/javascript">
        const red_color = 'rgb(220, 53, 69)';
        const orange_color = 'rgb(253, 126, 20)';
        const black_color = 'rgb(0, 0, 0)';


        function createPlot(data, labels, colors, bcolors, _table) {
            // Get the canvas element
            var ctx = document.getElementById('myChart').getContext('2d');

            // Create the chart object
            var myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Live Read',
                        data: data,
                        backgroundColor: colors,
                        borderColor: bcolors,
                        borderWidth: 1,
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    onClick: function (c, i) {
                        try {
                            actIdx = i[0].index
                            _table.row(actIdx).scrollTo();
                            _table.rows().deselect();
                            _table.row(actIdx).select();
                        } catch (err) {
                            void (0);
                        }
                    },
                    plugins: {
                        zoom: {
                            zoom: {
                                wheel: {
                                    enabled: true,
                                },
                                drag: {
                                    enabled: true
                                },
                                mode: 'xy',
                            }
                        }
                    }
                }
            });
            // reset zoom
            const resetZoomBtn = document.getElementById('resetZoomBtn');
            resetZoomBtn.addEventListener('click', function () {
                myChart.resetZoom();
            });
        }

        $(function () {
            var table = $('#data-table').DataTable({
                dom: 'Bfrtip',
                buttons: [
                    {
                        extend: 'csvHtml5',
                        text: 'Export All',
                        filename: "CavityFieldLimits_{{ retrieved_datetime }}",
                        exportOptions: {
                            modifier: {
                                search: 'none'
                            }
                        }
                    }],
                stateSave: true,
                scrollY: 800,
                scrollCollapse: true,
                scroller: true,
                paging: true,
                select: true,
                columnDefs: [
                    {
                        targets: [5, 6],
                        createdCell: function (td, cellData, rowData, row, col) {
                            if (cellData >= 0.951 * rowData[row, 3]) {
                                $(td).css('color', red_color);
                            } else {
                                $(td).css('color', black_color);
                            }
                        }
                    },
                    {
                        targets: [7, 8],
                        createdCell: function (td, cellData, rowData, row, col) {
                            if (cellData >= 0.951 * rowData[row, 3]) {
                                $(td).css('color', red_color);
                            } else if (cellData >= 0.951 * rowData[row, 5]) {
                                $(td).css('color', orange_color);
                            } else {
                                $(td).css('color', black_color);
                            }
                        }
                    },

                ]
            });

            // Get the data from the table
            const col_idx = 7
            const data = table.columns(col_idx).data().toArray()[0].map(Number);
            const cells = table.cells(`:nth-child(${col_idx + 1})`);
            const colors = cells.nodes().map(cell => $(cell).css('color')
                .replace(/rgb/i, 'rgba').replace(/\)/i, ', 0.3)')).toArray();
            const bcolors = colors.map(c => c.replace(/0.3\)/i, '0.95)'));
            const labels = table.columns(1).data().toArray()[0];
            const dnums = [];
            for (let i = 0; i < labels.length; i++) {
                dnums.push(labels[i].slice(-5));
            }
            createPlot(data, dnums, colors, bcolors, table);
        });

        function reloadIfDataIsNew() {
            fetch("/data-utils/is_cavity_data_new")
                .then(response => response.json())
                .then(data => {
                    if (data == true) {
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        $(function () {
            setInterval(reloadIfDataIsNew, 5000);
        });

    </script>
</body>

</html>